I"ª3<h2 id="baÅŸlangÄ±Ã§">BaÅŸlangÄ±Ã§</h2>

<p>Merhabalar bu yazÄ±mÄ±zda Spring Boot ve MySQL veri tabanÄ± kullanarak geliÅŸtirdiÄŸimiz bir uygulamayÄ± nasÄ±l Container iÃ§erisine alÄ±p Ã§alÄ±ÅŸtÄ±rabileceÄŸimizi Ã¶ÄŸreneceÄŸiz. YapacaÄŸÄ±mÄ±z iÅŸlemleri kuÅŸ bakÄ±ÅŸÄ± senarize edecek olursak ilk olarak MySQL Imageâ€™den Container oluÅŸturuyoruz. Daha sonra Spring Boot uygulamamÄ±zÄ± Containerize ediyoruz. Tabii ki Spring Boot Containerâ€™ Ä±mÄ±z MySQL Containerâ€™Ä±mÄ±z ile entegre ediliyor. Åimdi gelin bu adÄ±mlarÄ± hep beraber yapalÄ±m.</p>

<h2 id="mysql-container-oluÅŸturma">MySQL Container OluÅŸturma</h2>

<p>Ä°lk olarak <code class="highlighter-rouge">docker run mysql:5.7</code> komutunu terminale yazÄ±p Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda neler oluyor bir bakalÄ±m.Bu komut lokalde MySQL Imageâ€™ini arar ve Ã§alÄ±ÅŸtÄ±rÄ±r eÄŸer bulamazsa Docker Hub dan Ã¶nce MySQL Imageâ€™ini Ã§eker ve Ã§alÄ±ÅŸtÄ±rÄ±r.Bu komut ÅŸÃ¶yle bir error Ã¼retir.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>2020-03-22 19:34:13+00:00 [ERROR] [Entrypoint]: Database is uninitialized and password option is not specified
	You need to specify one of MYSQL_ROOT_PASSWORD, MYSQL_ALLOW_EMPTY_PASSWORD and MYSQL_RANDOM_ROOT_PASSWORD

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Bu hata veri tabanÄ± iÃ§in Root parolasÄ± tanÄ±mlamamÄ±zÄ± sÃ¶ylÃ¼yor bunu ÅŸu ÅŸekilde yapacaÄŸÄ±z.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker run <span class="nt">-d</span> <span class="nt">-e</span> <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>dummyrootpw <span class="nt">-e</span> <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>students <span class="nt">-e</span> <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span>dummyuserpw <span class="nt">-e</span> <span class="nv">MYSQL_USER</span><span class="o">=</span>dummyuser <span class="nt">-p</span> 3306:3306 <span class="nt">--name</span> mysql mysql:5.7
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Evet bu komutu hatasÄ±z girdiÄŸimizde oluÅŸan Containeâ€™Ä±n id si ekrana basÄ±lÄ±r. AynÄ± zamanda <code class="highlighter-rouge">container ls</code> komutu ile Containerâ€™Ä±mÄ±zÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± kontrol edebiliriz.</p>

<p>Evet ÅŸu anda Ã§alÄ±ÅŸan bir MySQL veri tabanÄ±na sahibiz bu veritabanÄ±na ister lokalde herhangi bir uygulamamÄ±zÄ± isterse Container iÃ§erisinde herhangi bir uygulamayÄ± baÄŸlayabiliriz. Biz containerize edeceÄŸimiz bir Spring Boot uygulamasÄ±nÄ± baÄŸlayacaÄŸÄ±z.</p>

<h2 id="spring-boot-container-oluÅŸturma">Spring Boot Container OluÅŸturma</h2>

<p>MySQL Container oluÅŸtururken environment olarak ayarladÄ±ÄŸÄ±mÄ±z <code class="highlighter-rouge">MYSQL_DATABASE</code> , <code class="highlighter-rouge">MYSQL_USER</code> ve <code class="highlighter-rouge">MYSQL_PASSWORD</code> deÄŸerlerini Spring uygulamamÄ±z iÃ§erisindeki <code class="highlighter-rouge">application.properties</code> dosyasÄ± iÃ§erisine aÅŸaÄŸÄ±daki gibi yazmamÄ±z gerekiyor.</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="py">spring.datasource.driver-class-name</span><span class="p">=</span><span class="s">com.mysql.cj.jdbc.Driver</span>
<span class="py">spring.jpa.hibernate.ddl-auto</span><span class="p">=</span><span class="s">update</span>
<span class="py">spring.datasource.url</span><span class="p">=</span><span class="s">jdbc:mysql://${RDS_HOSTNAME:localhost}:${RDS_PORT:3306}/${RDS_DB_NAME:students}</span>
<span class="py">spring.datasource.username</span><span class="p">=</span><span class="s">${RDS_USERNAME:dummyuser}</span>
<span class="py">spring.datasource.password</span><span class="p">=</span><span class="s">${RDS_PASSWORD:dummyuserpw}</span>
<span class="py">spring.jpa.properties.hibernate.dialect</span><span class="p">=</span><span class="s">org.hibernate.dialect.MySQL57Dialect</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>UygulamamÄ±z iÃ§erisinde veri tabanÄ±na baÄŸlanmak iÃ§in gerekli ayarlamalarÄ± yaptÄ±ktan sonra uygulamamÄ±zÄ± Container olarak yaÄŸa kaldÄ±rabiliriz.Bunun iÃ§in daha Ã¶nceki yazÄ±larda bahsettiÄŸimiz <code class="highlighter-rouge">Spotify Dockerfile Plugin</code> kullanacaÄŸÄ±z.</p>

<p>Dockerfile iÃ§eriÄŸimiz aÅŸaÄŸÄ±daki gibidir.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>FROM tomcat:8.0.51-jre8-alpine
RUN rm -rf /usr/local/tomcat/webapps/*
COPY ./target/*.war /usr/local/tomcat/webapps/ROOT.war
CMD ["catalina.sh","run"]
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="highlighter-rouge">mvn clean package -DskipTests</code> komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda uygulama klasÃ¶rÃ¼ altÄ±nda ki target dizini altÄ±na .war arÅŸivimiz oluÅŸur ve Image iÃ§erisine kopyalanÄ±r.</p>

<p>Evet Spring Boot uygulamamÄ±zÄ± iÃ§eren Imageâ€™imiz hazÄ±r aynÄ± zamanda MySQL Containerâ€™Ä±mÄ±zda Ã§alÄ±ÅŸÄ±r durumda geriye ikisi arasÄ±ndaki baÄŸlantÄ±yÄ± saÄŸlamak kaldÄ±.Bunun iÃ§in uygulama Imageâ€™Ä±mÄ±zÄ± aÅŸaÄŸÄ±daki ÅŸekilde run etmemiz gerekir.</p>

<h2 id="spring-boot-container-iÌ‡le-mysql-containeri-baÄŸlama">Spring Boot Container Ä°le MySQL Containerâ€™i BaÄŸlama</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker container run -p 8080:8080 --link=mysql -e RDS_HOSTNAME=mysql spring-mysql-app:1. 0.0-SNAPSHOT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>YukarÄ±daki komutta <code class="highlighter-rouge">--link mysql</code> parametresi ile spring uygulamamÄ±zÄ± mysql ile baÄŸlÄ±yoruz. <code class="highlighter-rouge">--link</code> baÄŸlayacaÄŸÄ±mÄ±z Containerâ€™Ä±n adÄ±nÄ± parametre alÄ±r. Fakat <code class="highlighter-rouge">--link</code> deprecated
bir parametredir. Bunun yerine Docker network yapÄ±larÄ±nÄ± kullanacaÄŸÄ±z. Åimdilik â€“link ile yapalÄ±m.</p>

<p><code class="highlighter-rouge">-e RDS_HOSTNAME=mysql</code> komutu da aÄŸ Ã¼zerindeki mysql veritabanÄ±na baÄŸlanmak iÃ§in gereklidir.</p>

<h2 id="docker-networking">Docker Networking</h2>

<p>Evet buraya kadar iÅŸin bÃ¼yÃ¼k bir kÄ±smÄ±nÄ± hallettik.Uygulama Containerâ€™Ä± ile MySQL Containerâ€™Ä± baÄŸlamak iÃ§in <code class="highlighter-rouge">--link=mysql</code> yapÄ±sÄ±nÄ± kullandÄ±k fakat â€“link Docker tarafÄ±ndan kullanÄ±mdan kaldÄ±rÄ±ldÄ±.Bunun yerine Docker Network kavramÄ±nÄ± kullanacaÄŸÄ±z.</p>

<p>Containerâ€™ler birbirleri ve dÄ±ÅŸ dÃ¼nya ile haberleÅŸmek iÃ§in farklÄ± tÃ¼rlerde aÄŸlar kullanÄ±rlar.Docker kurduÄŸumuzda default olarak Ã¼Ã§ network tanÄ±mlÄ±dÄ±r bunlarÄ± gÃ¶rmek iÃ§in
<code class="highlighter-rouge">docker network ls</code> komutunu Ã§alÄ±ÅŸtÄ±rÄ±rÄ±z.</p>

<ul>
  <li>host</li>
  <li>bridge</li>
  <li>none</li>
</ul>

<p><code class="highlighter-rouge">docker inspect bridge</code></p>

<p><code class="highlighter-rouge">docker inspect host</code></p>

<p>komutlarÄ± ile ilgili network Ã¼zerinde hangi Containerâ€™ler Ã§alÄ±ÅŸÄ±yor gÃ¶rebiliriz.Default olarak Containerâ€™ler <code class="highlighter-rouge">bridge</code> networkÃ¼nÃ¼ kullanÄ±rlar. Bizim Spring Boot uygulamamÄ±zda MySQL ile <code class="highlighter-rouge">bridge</code> networku Ã¼zerinden haberleÅŸmektedir.</p>

<p><strong>Not:</strong> <code class="highlighter-rouge">host</code> networku yalnÄ±zca linux sistemlerde vardÄ±r.</p>

<p>Herhangi bir Imageâ€™i bir network Ã¼zerinde Ã§alÄ±ÅŸtÄ±rmak iÃ§in ÅŸu ÅŸekilde bir komut yazarÄ±z.</p>

<p><code class="highlighter-rouge">docker run --network=host imageNanme</code></p>

<p>Evet bu bilgiler Ä±ÅŸÄ±ÄŸÄ±nda uygulamamÄ±za dÃ¶necek olursak eÄŸer host networkunu kullanÄ±rsak uygulamamÄ±z herhangi bir ek tanÄ±mlamaya gerek duymadan mysql ile haberleÅŸir ÅŸÃ¶yle ki</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>
docker container run <span class="nt">-p</span> 8080:8080 <span class="nt">--network</span><span class="o">=</span>host spring-mysql-app:0.0.1-SNAPSHOT

</pre></td></tr></tbody></table></code></pre></div></div>
<p>Bu komuta bakacak olursak port bilgisi ve rds_host bilgisi verilmedi. Ã‡Ã¼nkÃ¼ her iki Containerâ€™da host networku iÃ§erisindedir.</p>

<h2 id="Ã¶zel-network-oluÅŸturma">Ã–zel Network OluÅŸturma</h2>

<p>EÄŸer kendimize Ã¶zel bir aÄŸ oluÅŸturup Containerâ€™larÄ±mÄ±zÄ± bu aÄŸ Ã¼zerinde haberleÅŸtirmek istiyorsak ÅŸÃ¶yle yaparÄ±z.</p>

<pre><code class="language-shel">docker network create web-mysql-network
</code></pre>
<p>Bu konutu girdiÄŸimizde web-mysql-network isminde bir network oluÅŸur. Kontrol amacÄ±yla <code class="highlighter-rouge">docker network ls</code> komutunu kullanÄ±rsak <code class="highlighter-rouge">web-mysql-network</code> isminde ve <code class="highlighter-rouge">bridge</code> tÃ¼rÃ¼nde bir aÄŸÄ±n oluÅŸtuÄŸunu gÃ¶rÃ¼rÃ¼z.</p>

<p>SonuÃ§ olarak her iki Containerâ€™Ä±mÄ±zÄ± bu aÄŸ Ã¼zerinde Ã§alÄ±ÅŸtÄ±rÄ±rsak birbirleri ile haberleÅŸirler. Custom network olursa iki Containerâ€™Ä± birbirine baÄŸlamaya gerek yoktur.</p>

<p>MySQL Containerâ€™Ä±nÄ± Ã¶zel aÄŸÄ±mÄ±zda Ã§alÄ±ÅŸtÄ±rmak iÃ§in aÅŸaÄŸÄ±daki komutu kullanÄ±rÄ±z.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>docker run <span class="nt">-d</span> <span class="nt">-e</span> <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>dummyrootpw <span class="nt">-e</span> <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>students <span class="nt">-e</span> <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span>dummyuserpw <span class="nt">-e</span> <span class="nv">MYSQL_USER</span><span class="o">=</span>dummyuser <span class="nt">-p</span> 3306:3306 <span class="nt">--network</span><span class="o">=</span>web-mysql-network <span class="nt">--name</span> mysql mysql:5.7

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Spring Boot uygulama Containerâ€™Ä±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in ise</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker container run <span class="nt">-p</span> 8080:8080 <span class="nt">--network</span><span class="o">=</span>web-mysql-network <span class="nt">-e</span> <span class="nv">RDS_HOSTNAME</span><span class="o">=</span>mysql spring-mysql-app:0.0.1-SNAPSHOT
</pre></td></tr></tbody></table></code></pre></div></div>

<p>evet Containerâ€™larÄ±mÄ±z baÅŸarÄ±lÄ± bir ÅŸekilde ayaÄŸa kalktÄ± ve birbirleriyle iletiÅŸim halindeler.</p>

<p><code class="highlighter-rouge">docker inspect web-mysql-network</code> komutunu Ã§alÄ±ÅŸtÄ±rÄ±sak oluÅŸan Ã§Ä±ktÄ±da Containers bÃ¶lÃ¼mÃ¼nde uygulama ve mysql Containerâ€™lerimizi gÃ¶rÃ¼rÃ¼z.</p>

<p><img src="/assets/img/posts/spring-boot-docker-5/ss-network-inspect-1.png" alt="Image of ss-network-inspect-1" /></p>

<h2 id="veri-kalÄ±cÄ±lÄ±ÄŸÄ±nÄ±-saÄŸlama-docker-volumes">Veri KalÄ±cÄ±lÄ±ÄŸÄ±nÄ± SaÄŸlama-Docker Volumes</h2>

<p>MySQL Containerâ€™Ä±mÄ±z Ã§alÄ±ÅŸtÄ± ve uygulamamÄ±za veri girmeye baÅŸladÄ±k diyelim eÄŸer bu verileri <code class="highlighter-rouge">Docker Volume</code> kullanarak kalÄ±cÄ± hale getirmezsek Containerâ€™lar durduktan sonra veriler silinir.</p>

<p>Docker Containerâ€™larÄ± yapÄ±larÄ± itibari ile Ã¼zerinde Ã§alÄ±ÅŸtÄ±klarÄ± makiden baÄŸÄ±msÄ±z bir ÅŸekilde Ã§alÄ±ÅŸÄ±rlar ve herhangi bir durdurulma senaryosunda sÄ±fÄ±rdan baÅŸlarlar fakat birÃ§ok uygulama bu duruma uygun deÄŸildir mesela bizim MySQL Containerâ€™Ä±mÄ±z uygulama verilerini saklamakla gÃ¶revlidir yani bu Container dursa bile tekrar baÅŸladÄ±ÄŸÄ±nda verilerimizin kaybolmamasÄ± gerekir. Bunu saÄŸlamak iÃ§in Container iÃ§erisindeki verilerin tutulduÄŸu dizini host makine Ã¼zerindeki bir dizinle eÅŸleÅŸtiriyoruz bu ÅŸekilde Container fdursa bile yeni bir Container baÅŸlattÄ±ÄŸÄ±mÄ±zda host Ã¼zerindeki bu dizini volume olarak parametre alÄ±rsa veriler kaybolmadan baÅŸlamÄ±ÅŸ olur.</p>

<p><code class="highlighter-rouge">--volume data-directory-in-host-machine:/var/lib/mysql/</code> Containerâ€™Ä±mÄ±zÄ± ilk defa baÅŸlattÄ±ÄŸÄ±mÄ±zda bu ayarlamayÄ± yaparsak verilerimiz host Ã¼zerinde ilgili klasÃ¶re yedeklenmiÅŸ olur.</p>

:ET