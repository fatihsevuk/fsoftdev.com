I"šJ<h2 id="baÅŸlangÄ±Ã§">BaÅŸlangÄ±Ã§</h2>
<p>Merhabalar bu yazÄ±mÄ±zda fullstack bir uygulamayÄ± Docker ile nasÄ±l ayaÄŸa kaldÄ±racaÄŸÄ±mÄ±zÄ± adÄ±m adÄ±m inceleyeceÄŸiz. Frontend de React ile geliÅŸtirilmiÅŸ bir uygulama backend de yine Spring Boot ile geliÅŸtirilmiÅŸ bir REST APIâ€™ yi kullanacaÄŸÄ±z. Temel mantÄ±ÄŸÄ±mÄ±z ÅŸu olacak uygulamamÄ±z yÃ¼zde yÃ¼z taÅŸÄ±nabilir olacak yani hangi sistem Ã¼zerinde Ã§alÄ±ÅŸÄ±rsa Ã§alÄ±ÅŸsÄ±n herhangi bir sorun Ã§Ä±karmayacak.</p>

<h2 id="frontend-iÌ‡Ã§in-multi-stage-dockerfile-oluÅŸturma">Frontend Ä°Ã§in Multi Stage Dockerfile OluÅŸturma</h2>

<p>Frontend uygulamamÄ±z temelde <code class="highlighter-rouge">HTML</code>, <code class="highlighter-rouge">CSS</code> ve <code class="highlighter-rouge">JavaScript</code> dosyalarÄ±ndan oluÅŸmaktadÄ±r. Ve bu uygulamamÄ±zÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in bir web servera ihtiyaÃ§ duymaktayÄ±z. Biz web server olarak <code class="highlighter-rouge">nginx</code> kullanacaÄŸÄ±z. Frontend projemiz iÃ§in <code class="highlighter-rouge">multi stage</code> bir <code class="highlighter-rouge">Dockerfile</code> oluÅŸturacaÄŸÄ±z.</p>

<p>Dockerfile temel olarak ÅŸu adÄ±mlardan oluÅŸacak.</p>

<ul>
  <li>nodejs image Ã¼zerinde npm kullanarak projemizi build edeceÄŸiz.</li>
  <li>build edilmiÅŸ uygulama dosyalarÄ±mÄ±zÄ± nginx image Ã¼zerinde Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z.</li>
</ul>

<p>Proje klasÃ¶rÃ¼mÃ¼z iÃ§erisinde Dockerfile dosyamÄ±zÄ± oluÅŸturacaÄŸÄ±z.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="c">## Stage 1 - Lets build the "deployable package"</span>
FROM node:7. 10 as frontend-build
WORKDIR /fullstack/frontend

<span class="c"># Step 1 - Download all package dependencies first.</span>
<span class="c"># We will redownload dependencies only when packages change.</span>
COPY package. json package-lock. json <span class="nb">.</span> /
RUN npm <span class="nb">install</span>

<span class="c"># Step 2 - Copy all source and run build</span>
COPY <span class="nb">.</span> <span class="nb">.</span> /
RUN npm run build

<span class="c">## Stage 2 - Let's build a minimal image with the "deployable package"</span>
FROM nginx:1. 12-alpine
COPY <span class="nt">--from</span><span class="o">=</span>frontend-build /fullstack/frontend/build /usr/share/nginx/html
EXPOSE 80
CMD <span class="o">[</span><span class="s2">"nginx"</span>, <span class="s2">"-g"</span>, <span class="s2">"daemon off;"</span><span class="o">]</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Dockerfileâ€™Ä± inceleyecek olursak <code class="highlighter-rouge">npm run build</code> iÅŸlemi var bu iÅŸlem sonunda <code class="highlighter-rouge">node_modules</code> isminde bir klasÃ¶r oluÅŸur build iÅŸleminden sonra bu klasÃ¶re ihtiyacÄ±mÄ±z yoktur. O yÃ¼zden Dockerâ€™Ä±n bu klasÃ¶rÃ¼ es geÃ§mesini istiyoruz bunu saÄŸlamak iÃ§in <code class="highlighter-rouge">.dockerignore</code> isimli bir dosya oluÅŸturup bu klasÃ¶r ismini o dosyaya eklememiz gerekir.</p>

<p>TÃ¼m bu iÅŸlemleri yaptÄ±ktan sonra frontend Containerâ€™Ä±mÄ±zÄ± ayaÄŸa kaldÄ±rmaya hazÄ±rÄ±z. Ä°lk olarak Dockerfileâ€™dan Imageâ€™Ä±mÄ±zÄ± oluÅŸturacaÄŸÄ±z bunun iÃ§in</p>

<p><code class="highlighter-rouge">docker build . </code> yada <code class="highlighter-rouge">docker build -t tagName . </code> komutlarÄ±nÄ± kullanÄ±rÄ±z ikinci komuttaki <code class="highlighter-rouge">tagName</code> kÄ±smÄ±na istediÄŸimiz bir tag ismi verebiliriz.</p>

<p>EÄŸer Imageâ€™imizin baÅŸarÄ±lÄ± bir ÅŸekilde oluÅŸtuÄŸundan emin olduktan sonra aÅŸaÄŸÄ±daki komut ile Containerâ€™Ä±mÄ±zÄ± ayaÄŸa kaldÄ±rabiliriz.</p>

<p><code class="highlighter-rouge">docker run -p 4200:80 react-app:1. 0.0-SNAPSHOT</code></p>

<p>Burada nginxâ€™in 80 portunu hostâ€™un 4200 portu ile eÅŸleÅŸtirdik.</p>

<p>Bu komut Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda herhangi bir konsol Ã§Ä±ktÄ±sÄ± Ã¼retmez ta ki <code class="highlighter-rouge">localhost:4200</code> adresine tarayÄ±cÄ±mÄ±zdan gidene kadar.</p>

<p>Evet sonuÃ§ olarak gÃ¶rdÃ¼ÄŸÃ¼nÃ¼z Ã¼zere manuel olarak hiÃ§bir kurulum yapmadan uygulamamÄ±zÄ± ayaÄŸa kaldÄ±rdÄ±k. Bu Dockerfile ile herhangi bir sistem Ã¼zerinde extradan hiÃ§bir ÅŸeye ihtiyaÃ§ kalmadan uygulamamÄ±zÄ± run edebiliriz.</p>

<h2 id="backend-iÌ‡Ã§in-multi-stage-dockerfile-oluÅŸturma">Backend Ä°Ã§in Multi Stage Dockerfile OluÅŸturma</h2>

<p>Backend Imageâ€™imizide iki stage olarak gerÃ§ekleÅŸtireceÄŸiz:</p>

<ul>
  <li>Ä°lk olarak Maven Imageâ€™ini indirip projemiz iÃ§in gerekli tÃ¼m dependencyâ€™leri indireceÄŸiz.</li>
  <li>Daha sonra openjdk Imageâ€™ini indirip uygualamÄ±zÄ± run edeceÄŸiz.</li>
</ul>

<p>Dockerfileâ€™Ä±mÄ±z aÅŸaÄŸÄ±da ki gibidir.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre><span class="c">##### Stage 1 - Lets build the "deployable package"</span>

FROM maven:3.6.1-jdk-8-alpine as backend-build
WORKDIR /fullstack/backend

<span class="c">### Step 1 - Copy pom. xml and download project dependencies</span>

<span class="c"># Dividing copy into two steps to ensure that we download dependencies</span>
<span class="c"># only when pom. xml changes</span>
COPY pom. xml <span class="nb">.</span>
<span class="c"># dependency:go-offline - Goal that resolves all project dependencies,</span>
<span class="c"># including plugins and reports and their dependencies. -B -&gt; Batch mode</span>
RUN mvn dependency:go-offline <span class="nt">-B</span>

<span class="c">### Step 2 - Copy source and build "deployable package"</span>
COPY src src
RUN mvn <span class="nb">install</span> <span class="nt">-DskipTests</span>

<span class="c"># Unzip</span>
RUN <span class="nb">mkdir</span> <span class="nt">-p</span> target/dependency <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nb">cd </span>target/dependency<span class="p">;</span> jar <span class="nt">-xf</span> ../<span class="k">*</span>.jar<span class="o">)</span>

<span class="c">##### Stage 2 - Let's build a minimal image with the "deployable package"</span>
FROM openjdk:8-jdk-alpine
VOLUME /tmp
ARG <span class="nv">DEPENDENCY</span><span class="o">=</span>/fullstack/backend/target/dependency
COPY <span class="nt">--from</span><span class="o">=</span>backend-build <span class="k">${</span><span class="nv">DEPENDENCY</span><span class="k">}</span>/BOOT-INF/lib /app/lib
COPY <span class="nt">--from</span><span class="o">=</span>backend-build <span class="k">${</span><span class="nv">DEPENDENCY</span><span class="k">}</span>/META-INF /app/META-INF
COPY <span class="nt">--from</span><span class="o">=</span>backend-build <span class="k">${</span><span class="nv">DEPENDENCY</span><span class="k">}</span>/BOOT-INF/classes /app
ENTRYPOINT <span class="o">[</span><span class="s2">"java"</span>,<span class="s2">"-cp"</span>,<span class="s2">"app:app/lib/*"</span>,<span class="s2">"com. in28minutes. rest. webservices. restfulwebservices. RestfulWebServicesApplication"</span><span class="o">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="highlighter-rouge">docker build . </code> komutu ile uygulama Imageâ€™ini oluÅŸtururuz daha sonra,</p>

<p><code class="highlighter-rouge">docker run -p 8080:8080 imageName:tag</code> komutu ile Containerâ€™Ä±mÄ±zÄ± ayaÄŸa kaldÄ±rÄ±rÄ±z burada <code class="highlighter-rouge">imageName:Tag</code> kÄ±smÄ±na ilgili Image ile ilgili bilgiler gelir.</p>

<h2 id="docker-compose">Docker Compose</h2>

<p>Åu ana kadar ki anlatÄ±mlarÄ±mÄ±zda maximum 2 Container ile uygulama geliÅŸtirdik fakat real world durumlarda Container sayÄ±sÄ± bu kadar az olmaz. Container sayÄ±sÄ± arttÄ±kÃ§a bu Containerâ€™larÄ± yÃ¶netmek iÃ§inden Ã§Ä±kÄ±lamaz bir hÃ¢l alabilir. Bu durumu yÃ¶netmek iÃ§in Docker Compose iyi bir Ã§Ã¶zÃ¼mdÃ¼r.</p>

<p>Docker Compose kurulumunu Docker offical dÃ¶kÃ¼manÄ±ndan yapabilirsiniz. Kurulumu yaptÄ±ktan sonra projemiz iÃ§in <code class="highlighter-rouge">docker-compose. yml</code> dosyamÄ±zÄ± oluÅŸtururuz.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.7'</span>
<span class="c1"># Removed subprocess. CalledProcessError: Command '['/usr/local/bin/docker-credential-desktop', 'get']' returned non-zero exit status 1</span>
<span class="c1"># I had this:</span>
<span class="c1"># cat ~/. docker/config. json</span>
<span class="c1"># {"auths":{},"credsStore":"", "credsStore":"desktop","stackOrchestrator":"swarm"}</span>
<span class="c1"># I updated to this:</span>
<span class="c1"># {"auths":{},"credsStore":"","stackOrchestrator":"swarm"}</span>
<span class="na">services</span><span class="pi">:</span>
<span class="na">todo-web-application</span><span class="pi">:</span>
<span class="na">image</span><span class="pi">:</span> <span class="s">in28min/todo-web-application-mysql:0.0.1-SNAPSHOT</span>
<span class="c1">#build:</span>
<span class="c1">#context: .</span>
<span class="c1">#dockerfile: Dockerfile</span>
<span class="na">ports</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">8080:8080"</span>
<span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
<span class="na">depends_on</span><span class="pi">:</span> <span class="c1"># Start the depends_on first</span>
<span class="pi">-</span> <span class="s">mysql</span>
<span class="na">environment</span><span class="pi">:</span>
<span class="na">RDS_HOSTNAME</span><span class="pi">:</span> <span class="s">mysql</span>
<span class="na">RDS_PORT</span><span class="pi">:</span> <span class="m">3306</span>
<span class="na">RDS_DB_NAME</span><span class="pi">:</span> <span class="s">todos</span>
<span class="na">RDS_USERNAME</span><span class="pi">:</span> <span class="s">todos-user</span>
<span class="na">RDS_PASSWORD</span><span class="pi">:</span> <span class="s">dummytodos</span>
<span class="na">networks</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">todo-web-application-network</span>

<span class="na">mysql</span><span class="pi">:</span>
<span class="na">image</span><span class="pi">:</span> <span class="s">mysql:5.7</span>
<span class="na">ports</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s2">"</span><span class="s">3306:3306"</span>
<span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
<span class="na">environment</span><span class="pi">:</span>
<span class="na">MYSQL_ROOT_PASSWORD</span><span class="pi">:</span> <span class="s">root</span>
<span class="na">MYSQL_ROOT_PASSWORD</span><span class="pi">:</span> <span class="s">dummypassword</span>
<span class="na">MYSQL_USER</span><span class="pi">:</span> <span class="s">todos-user</span>
<span class="na">MYSQL_PASSWORD</span><span class="pi">:</span> <span class="s">dummytodos</span>
<span class="na">MYSQL_DATABASE</span><span class="pi">:</span> <span class="s">todos</span>
<span class="na">volumes</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">mysql-database-data-volume:/var/lib/mysql</span>
<span class="na">networks</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">todo-web-application-network</span>

<span class="c1"># Volumes</span>
<span class="na">volumes</span><span class="pi">:</span>
<span class="na">mysql-database-data-volume</span><span class="pi">:</span>

<span class="na">networks</span><span class="pi">:</span>
<span class="na">todo-web-application-network</span><span class="pi">:</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Evet docker-compose. yml dosyamÄ±zÄ± oluÅŸturdaktan sonra</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose up
</pre></td></tr></tbody></table></code></pre></div></div>
<p>komutu ile Containerâ€™larÄ±mÄ±zÄ± ayaÄŸa kaldÄ±rÄ±rÄ±z.</p>

<h2 id="docker-compose-komutlarÄ±">Docker Compose KomutlarÄ±</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose down
</pre></td></tr></tbody></table></code></pre></div></div>
<p>komutu ile Containerâ€™larÄ±mÄ±zÄ± durdururuz.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose events
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ile Ã§alÄ±ÅŸan Containerâ€™larÄ±mÄ±z ile ilgili bilgileri alÄ±rÄ±z.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose config
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ile docker-compose dosyamÄ±zdaki ayarlara eriÅŸiriz.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose images
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ile hangi Imageâ€™lerin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶rÃ¼rÃ¼z.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose ps
</pre></td></tr></tbody></table></code></pre></div></div>
<p>ile kullanÄ±lan Containerâ€™larÄ±n durumunu hangi port Ã¼zerinde Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± ve hangi komutlarla baÅŸladÄ±ÄŸÄ±nÄ± gÃ¶rÃ¼rÃ¼z.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose top
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Her Containerâ€™Ä±n iÃ§erindeki tÃ¼m processleri gÃ¶sterir.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose pause
</pre></td></tr></tbody></table></code></pre></div></div>
<p>TÃ¼m Containerâ€™larÄ± <code class="highlighter-rouge">paused</code> durumuna Ã§eker.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose unpause
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="highlighter-rouge">paused</code> Containerâ€™larÄ± Ã§alÄ±ÅŸtÄ±rÄ±r.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker-compose stop
</pre></td></tr></tbody></table></code></pre></div></div>
<p>TÃ¼m Containerâ€™larÄ± durdurur.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker compose kill
</pre></td></tr></tbody></table></code></pre></div></div>

<p>TÃ¼m Containerâ€™larÄ± kill yapar.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker compose rm
</pre></td></tr></tbody></table></code></pre></div></div>
<p>DurmuÅŸ ContainerlarÄ± siler.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>docker compose build
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Bu komut ÅŸu ÅŸekilde kullanÄ±lÄ±r <code class="highlighter-rouge">docker-compose. yml</code> dosyasÄ±ndaki servislere ait Imageâ€™ler oluÅŸmamÄ±ÅŸsa ya da biz yeniden oluÅŸturmak istiyorsak aÅŸaÄŸÄ±daki comment kÄ±sÄ±mlarÄ± aktif hale getiririz ve komutu Ã§alÄ±ÅŸtÄ±r.</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1">#build:</span>
<span class="c1">#context: .</span>
<span class="c1">#dockerfile: Dockerfile</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Evet RomalÄ±lar bu yazÄ±nÄ±n ve de aynÄ± zamanda yazÄ± dizimizin sonuna gelmiÅŸ bulunmaktayÄ±z. Åimdiye kadar ki anlatÄ±mlardan anlayacaÄŸÄ±nÄ±z Ã¼zere ne Dockerâ€™Ä± ne deSpring Bootâ€™un detayÄ±na inmedik Ã§Ã¼nkÃ¼ amacÄ±mÄ±z bu iki konsepti entegre etmekti ve bunu da 6 yazÄ± serisinde tÃ¼m hatlarÄ±yla ele aldÄ±k.</p>

<p>Bu yazÄ± serisinin baÅŸÄ±nda da belirttiÄŸim Ã¼zere bu seriyi yazarken</p>

<p><a href="https://www.udemy.com/course/docker-course-with-java-and-spring-boot-for-beginners/">Master Docker With Java-Devops For Spring Microservices</a></p>

<p>kursunda tuttuÄŸum notlardan ve kursun github adresindeki kodlardan faydalandÄ±m.</p>

<p><a href="https://github.com/in28minutes/docker-crash-course">Docker Crash Course Github </a></p>

<p>Bu seri daha Ã§ok kendim iÃ§in bir kaynak oluÅŸturmak ve takÄ±ldÄ±ÄŸÄ±m yerlerde bakabileceÄŸim derli toplu bir dokÃ¼man olmasÄ± amacÄ±yla yazÄ±ldÄ± umarÄ±m sizlerinde bir nebze olsun iÅŸinize yaramÄ±ÅŸtÄ±r.</p>

<h2 id="kaynaklar">Kaynaklar</h2>

<p><a href="https://github.com/in28minutes/docker-crash-course">https://github.com/in28minutes/docker-crash-course</a></p>

<p><a href="https://www.udemy.com/course/docker-course-with-java-and-spring-boot-for-beginners/">https://www.udemy.com/course/docker-course-with-java-and-spring-boot-for-beginners/</a></p>

<p><a href="https://docs.docker.com/compose/">https://docs.docker.com/compose/</a></p>

:ET